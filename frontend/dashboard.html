<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<header class="navbar">
  <div class="logo">Dashboard</div>
  <nav>
    <a href="index.html">Home</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main class="main">

  <!-- ================= EXISTING STATS (PRESERVED) ================= -->
  <section class="card">
    <h2>Test Statistics</h2>

    <div class="stats-grid">
      <div class="stat">
        <h4>Total</h4>
        <span id="total">0</span>
      </div>

      <div class="stat success">
        <h4>Passed</h4>
        <span id="passed">0</span>
      </div>

      <div class="stat danger">
        <h4>Failed</h4>
        <span id="failed">0</span>
      </div>
    </div>

    <br>
    <progress id="progress" max="100" value="0" style="width:100%"></progress>
  </section>

  <!-- ================= 5ï¸âƒ£ BROWSER ACTIVITY ================= -->
  <section class="card">
    <h3>Browser Activity</h3>
    <p id="browserStatus">ðŸ”´ Idle</p>
  </section>

  <!-- ================= 3ï¸âƒ£ RECENT TEST EXECUTIONS (FORMATTED) ================= -->
  <section class="card">
    <h3>Recent Test Executions</h3>
    <ul id="timeline" style="list-style:none;padding:0;"></ul>
  </section>

  <!-- ================= 4ï¸âƒ£ FAILURE SUMMARY ================= -->
  <section class="card">
    <h3>Failure Reasons</h3>
    <ul id="failureSummary"></ul>
  </section>

  <!-- ================= 8ï¸âƒ£ LATEST REPORT ================= -->
  <section class="card">
    <h3>Latest Report</h3>
    <a id="latestReport" href="#" target="_blank">No reports yet</a>
  </section>

</main>

<script>
const BACKEND_URL = "http://127.0.0.1:5000";

/* ================= 7ï¸âƒ£ ANIMATED COUNTER ================= */
function animateValue(el, start, end) {
  let current = start;
  const step = Math.max(1, Math.floor((end - start) / 20));
  const interval = setInterval(() => {
    current += step;
    if (current >= end) {
      current = end;
      clearInterval(interval);
    }
    el.innerText = current;
  }, 40);
}

/* ================= LOAD STATS ================= */
fetch(`${BACKEND_URL}/stats`)
  .then(r => r.json())
  .then(s => {
    animateValue(total, 0, s.total);
    animateValue(passed, 0, s.passed);
    animateValue(failed, 0, s.failed);
    progress.value = (s.passed / s.total) * 100 || 0;
  });

/* ================= LOAD HISTORY ================= */
fetch(`${BACKEND_URL}/history`)
  .then(r => r.json())
  .then(list => {

    /* 5ï¸âƒ£ Browser Activity */
    browserStatus.innerText = list.length ? "ðŸŸ¢ Active" : "ðŸ”´ Idle";

    /* 3ï¸âƒ£ RECENT TEST EXECUTIONS (USER FRIENDLY) */
    timeline.innerHTML = "";

    list.slice(0, 5).forEach(t => {
      const li = document.createElement("li");

      // Convert timestamp â†’ readable format
      const d = new Date(
        t.time.substring(0,4),
        t.time.substring(4,6)-1,
        t.time.substring(6,8),
        t.time.substring(9,11),
        t.time.substring(11,13)
      );

      const readable = d.toLocaleString("en-IN", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });

      li.style.background = "#f2f4ff";
      li.style.padding = "12px";
      li.style.borderRadius = "12px";
      li.style.marginBottom = "8px";

      li.innerHTML = `
        <b>${readable}</b>
        <span style="float:right;color:${t.status==="PASSED"?"green":"red"}">
          ${t.status}
        </span>
      `;

      timeline.appendChild(li);
    });

    /* 4ï¸âƒ£ FAILURE SUMMARY */
    const reasons = {};
    list.forEach(t => {
      if (t.failure_reason) {
        reasons[t.failure_reason] =
          (reasons[t.failure_reason] || 0) + 1;
      }
    });

    failureSummary.innerHTML = "";
    if (!Object.keys(reasons).length) {
      failureSummary.innerHTML = "<li>No failures ðŸŽ‰</li>";
    } else {
      for (let r in reasons) {
        const li = document.createElement("li");
        li.innerText = `${r} â€” ${reasons[r]} times`;
        failureSummary.appendChild(li);
      }
    }
  });

/* ================= 8ï¸âƒ£ LATEST REPORT ================= */
fetch(`${BACKEND_URL}/reports-list`)
  .then(r => r.json())
  .then(files => {
    if (files.length) {
      latestReport.href = `${BACKEND_URL}/reports/${files[0]}`;
      latestReport.innerText = "Open Latest Report";
    }
  });
</script>

</body>
</html>

