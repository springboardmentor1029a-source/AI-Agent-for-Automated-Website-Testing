<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agentic AI Testing Page</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    header {
      background: #111;
      color: #fff;
      padding: 15px 20px;
    }

    nav {
      display: flex;
      gap: 20px;
    }

    nav a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    nav a:hover {
      color: cyan;
      text-shadow: 0 0 8px cyan;
    }

    .container {
      display: flex;
      padding: 20px;
      gap: 20px;
    }

    .input-box,
    .output-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .input-box {
      width: 40%;
    }

    .input-box input {
      width: 95%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .input-box button {
      padding: 10px 18px;
      background: #111;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .input-box button:hover {
      background: cyan;
      color: black;
      box-shadow: 0 0 12px cyan;
    }

    /* Spinner */
    .spinner {
      display: none;
      margin: 20px auto;
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top: 4px solid cyan;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    pre {
      background: #eee;
      padding: 12px;
      overflow-x: auto;
      border-radius: 8px;
      font-size: 13px;
    }

    /* RESULT PANEL */

    #result-panel {
      display: none;
      margin-top: 10px;
    }

    #status-badge {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .status-pass {
      color: #22c55e;
    }

    .status-fail {
      color: #ef4444;
    }

    .status-blocked {
      color: #f59e0b;
    }

    #final-screenshot {
      margin-top: 15px;
      max-width: 100%;
      border-radius: 10px;
      border: 1px solid #ddd;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <a href="/">Home</a>
      <a href="/logs">Logs</a>
    </nav>
  </header>

  <div class="container">
    <div class="input-box">
      <h3>ðŸ”¬ E2E Testing</h3>
      <input type="text" id="instruction" placeholder="Enter your testing instruction" />
      <button onclick="runTest()">Execute</button>
      <div class="spinner" id="spinner"></div>
    </div>

    <div class="output-box" style="flex-grow:1;">
      <h3>Parser Output</h3>
      <pre id="parserOutput">Waiting...</pre>
    </div>
  </div>

  <div class="container">
    <div class="output-box" style="width:100%;">
      <h3>Execution Result</h3>

      <!-- Clean result panel -->
      <div id="result-panel">
        <div id="status-badge"></div>
        <p id="verbal-result"></p>
        <img id="final-screenshot" />
      </div>

      <!-- Debug JSON (collapsed) -->
      <details style="margin-top:15px;">
        <summary>Debug Playwright JSON</summary>
        <pre id="playwrightOutput">Waiting...</pre>
      </details>
    </div>
  </div>

  <script>
    async function runTest() {
      const instruction = document.getElementById("instruction").value;
      const spinner = document.getElementById("spinner");
      const parserOut = document.getElementById("parserOutput");
      const debugOut = document.getElementById("playwrightOutput");

      const panel = document.getElementById("result-panel");
      const badge = document.getElementById("status-badge");
      const verbal = document.getElementById("verbal-result");
      const screenshot = document.getElementById("final-screenshot");

      panel.style.display = "none";
      spinner.style.display = "block";
      parserOut.textContent = "Running...";
      debugOut.textContent = "Running...";

      const res = await fetch("/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ instruction })
      });

      const { job_id } = await res.json();

      const poll = setInterval(async () => {
        const statusRes = await fetch(`/test-status/${job_id}`);
        const data = await statusRes.json();

        if (data.status === "DONE") {
          clearInterval(poll);
          spinner.style.display = "none";

          // Parser output
          parserOut.textContent = data.output;

          // Debug JSON
          debugOut.textContent = JSON.stringify(data.playwright, null, 2);

          
          const result = data.playwright;
          panel.style.display = "block";

          badge.className = "";
          badge.textContent = result.overall_status;

          if (result.overall_status === "PASS") {
            badge.classList.add("status-pass");
          } else if (result.overall_status === "BLOCKED") {
            badge.classList.add("status-blocked");
          } else {
            badge.classList.add("status-fail");
          }

          verbal.textContent =
            result.verbal_result || "Execution completed.";

          if (result.final_screenshot) {
            screenshot.src = "/" + result.final_screenshot;
            screenshot.style.display = "block";
          } else {
            screenshot.style.display = "none";
          }
        }
      }, 1000);
    }
  </script>
</body>

</html>