<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Use WebUI - AI Testing Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0e1a;
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.3;
            background: 
                radial-gradient(circle at 20% 50%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-left p {
            font-size: 0.875rem;
            color: #94a3b8;
            font-weight: 400;
        }

        .header-right {
            display: flex;
            gap: 12px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            background: rgba(17, 24, 39, 0.6);
            padding: 6px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(99, 102, 241, 0.15);
            backdrop-filter: blur(10px);
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 7px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab:hover {
            background: rgba(99, 102, 241, 0.1);
            color: #e2e8f0;
        }

        .tab.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        /* Main Content */
        .content {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .content::-webkit-scrollbar {
            width: 8px;
        }

        .content::-webkit-scrollbar-track {
            background: rgba(17, 24, 39, 0.5);
            border-radius: 4px;
        }

        .content::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 4px;
        }

        .content::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.7);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Section */
        .form-section {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 500;
            color: #cbd5e1;
            margin-bottom: 6px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 0.875rem;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 18px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: rgba(71, 85, 105, 0.3);
            color: #cbd5e1;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(71, 85, 105, 0.5);
            border-color: rgba(148, 163, 184, 0.3);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .btn-success {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 18px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8125rem;
        }

        /* Recording Control */
        .recording-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.15);
            margin-bottom: 18px;
        }

        .recording-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8125rem;
            color: #94a3b8;
        }

        .recording-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #64748b;
        }

        .recording-indicator.active {
            background: #ef4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Results */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-card {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.5), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .result-card:hover::before {
            opacity: 1;
        }

        .result-card.success {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
        }

        .result-card.success::before {
            background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.6), transparent);
        }

        .result-card.error {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.05);
        }

        .result-card.error::before {
            background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.6), transparent);
        }

        .result-label {
            font-size: 0.85rem;
            color: #94a3b8;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 2rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        /* Steps List */
        .steps-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .step-item {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-left: 3px solid #64748b;
            border-radius: 10px;
            padding: 16px 20px;
            transition: all 0.3s;
        }

        .step-item.passed {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, 0.05);
        }

        .step-item.failed {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .step-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #e2e8f0;
        }

        .step-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .step-badge.passed {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .step-badge.failed {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .step-description {
            font-size: 0.9rem;
            color: #94a3b8;
            line-height: 1.5;
        }

        .step-screenshot {
            margin-top: 12px;
        }

        .step-screenshot a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.85rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s;
        }

        .step-screenshot a:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }

        /* Code Viewer */
        .code-viewer {
            margin-top: 30px;
        }

        .code-header {
            background: rgba(15, 23, 42, 0.6);
            padding: 16px 20px;
            border-radius: 10px 10px 0 0;
            border: 1px solid rgba(148, 163, 184, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .code-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #e2e8f0;
        }

        .code-content {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-top: none;
            border-radius: 0 0 10px 10px;
            overflow: hidden;
            display: none;
        }

        .code-content.open {
            display: block;
        }

        .code-pre {
            margin: 0;
            padding: 16px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8125rem;
            line-height: 1.5;
            color: #cbd5e1;
            max-height: 400px;
            overflow-y: auto;
        }

        .code-pre::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .code-pre::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
        }

        .code-pre::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 3px;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(59, 130, 246, 0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1rem;
            color: #94a3b8;
        }

        /* History */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 10px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: rgba(15, 23, 42, 0.6);
            border-color: rgba(148, 163, 184, 0.2);
            transform: translateX(4px);
        }

        .history-time {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 6px;
        }

        .history-url {
            font-size: 0.95rem;
            color: #e2e8f0;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .history-result {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        /* Status Summary */
        .status-summary {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 2px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .status-summary.failed {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .status-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .status-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .status-subtitle {
            font-size: 1rem;
            color: #94a3b8;
        }

        /* Progress Bar */
        .progress-container {
            margin: 20px 0;
            padding: 0 30px;
        }

        .progress-bar-wrapper {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #10b981);
            border-radius: 10px;
            transition: width 1s ease-out;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-bar.failed-progress {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .progress-label {
            text-align: center;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #94a3b8;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .content {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>ü§ñ Yash AI Testing Agent</h1>
                <p>Intelligent Browser Automation Platform</p>
            </div>
            <div class="header-right">
                <button class="btn btn-secondary btn-sm" onclick="window.location.href='/'">
                    üè† Home
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('run-agent')">
                <span>ü§ñ</span> Agent Settings
            </button>
            <button class="tab" onclick="switchTab('run-agent')">
                <span>‚ñ∂Ô∏è</span> Run Agent
            </button>
            <button class="tab" onclick="switchTab('recordings')">
                <span>üìπ</span> Recordings
            </button>
            <button class="tab" onclick="switchTab('history')">
                <span>üìä</span> Results
            </button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Run Agent Tab -->
            <div id="run-agent" class="tab-content active">
                <form id="testForm" onsubmit="runTest(event)">
                    <!-- Quick Examples -->
                    <div style="margin-bottom: 18px;">
                        <label class="form-label">Quick Examples (Click to use)</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="useExample('go to google.com and type \'OpenAI\', click search and give me the first url')">
                                Google Search
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="useExample('go to amazon.com, wait 2 seconds, then search for \'laptop\'')">
                                Amazon Search
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="useExample('go to youtube.com and search for \'AI tutorial\'')">
                                YouTube Search
                            </button>
                        </div>
                    </div>

                    <div class="form-section">
                        <label class="form-label">Task Description</label>
                        <textarea 
                            class="form-textarea" 
                            id="taskDescription" 
                            placeholder="Describe what you want the agent to do..."
                            required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-section">
                            <label class="form-label">Browser</label>
                            <select class="form-select" id="browser">
                                <option value="chromium">Google Chrome</option>
                                <option value="firefox">Firefox</option>
                                <option value="msedge">Microsoft Edge</option>
                            </select>
                        </div>

                        <div class="form-section">
                            <label class="form-label">Mode</label>
                            <select class="form-select" id="mode">
                                <option value="visible">Visible</option>
                                <option value="headless">Headless</option>
                            </select>
                        </div>

                        <div class="form-section">
                            <label class="form-label">Recording</label>
                            <select class="form-select" id="recordingToggle">
                                <option value="off">Off</option>
                                <option value="on">On</option>
                            </select>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            ‚ñ∂Ô∏è Run Agent
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            Clear
                        </button>
                        <button type="button" class="btn btn-danger" onclick="stopTest()">
                            ‚èπÔ∏è Stop
                        </button>
                    </div>
                </form>

                <!-- Loading -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">AI Agent is processing your request...</div>
                </div>

                <!-- Results -->
                <div id="results" style="display: none; margin-top: 40px;">
                    <!-- Status Summary -->
                    <div class="status-summary" id="statusSummary">
                        <div class="status-icon" id="statusIcon">‚úÖ</div>
                        <div class="status-title" id="statusTitle">Test Passed</div>
                        <div class="status-subtitle" id="statusSubtitle">All steps completed successfully</div>
                    </div>

                    <!-- Results Grid -->
                    <div class="results-grid" id="resultsGrid"></div>

                    <!-- Steps List -->
                    <div style="margin-top: 30px;">
                        <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 20px; color: #e2e8f0;">
                            üìã Execution Steps
                        </h3>
                        <div class="steps-list" id="stepsList"></div>
                    </div>

                    <!-- Code Viewer -->
                    <div class="code-viewer" style="margin-top: 24px;">
                        <div class="code-header" onclick="toggleCode()">
                            <div class="code-title">
                                <span id="codeToggleIcon">‚ñ∂</span> Generated Playwright Code
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); copyCode()">
                                üìã Copy
                            </button>
                        </div>
                        <div class="code-content" id="codeContent">
                            <pre class="code-pre" id="generatedCode"></pre>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="downloadReport('json')">
                            üì• JSON
                        </button>
                        <button class="btn btn-primary" onclick="downloadReport('pdf')">
                            üìÑ PDF
                        </button>
                        <button class="btn btn-secondary" onclick="newTest()">
                            ‚ûï New Test
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recordings Tab -->
            <div id="recordings" class="tab-content">
                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 20px;">üìπ Recorded Sessions</h2>
                <div id="recordingsList">
                    <p style="color: #64748b; text-align: center; padding: 40px;">No recordings available yet</p>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 1.5rem; font-weight: 600;">üìä Test History</h2>
                    <button class="btn btn-danger" onclick="clearHistory()">
                        üóëÔ∏è Clear All History
                    </button>
                </div>
                <div class="history-list" id="historyList">
                    <p style="color: #64748b; text-align: center; padding: 40px;">No test history yet</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // FORCE CLEAR ALL HISTORY - FIX FOR BROKEN DATA
        localStorage.clear();
        
        let currentResult = null;
        let testHistory = [];

        // Tab switching
        function switchTab(tabId, clickEvent) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Find and activate the correct tab button
            const tabButton = document.querySelector(`[onclick*="switchTab('${tabId}')"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // Activate the content
            const contentElement = document.getElementById(tabId);
            if (contentElement) {
                contentElement.classList.add('active');
            }

            if (tabId === 'history') {
                renderHistory();
            }
        }

        // Use example
        function useExample(text) {
            document.getElementById('taskDescription').value = text;
        }

        // Stop test
        function stopTest() {
            alert('Test stopped (feature in development)');
        }

        // Run test
        async function runTest(event) {
            event.preventDefault();

            const taskDescription = document.getElementById('taskDescription').value;
            const browser = document.getElementById('browser').value;
            const mode = document.getElementById('mode').value;
            const recording = document.getElementById('recordingToggle').value;

            // Extract URL from task description
            const urlMatch = taskDescription.match(/https?:\/\/[^\s]+|(?:www\.)?[a-z0-9-]+\.[a-z]{2,}/i);
            const url = urlMatch ? (urlMatch[0].startsWith('http') ? urlMatch[0] : 'https://' + urlMatch[0]) : 'https://google.com';

            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').style.display = 'none';

            try {
                const response = await fetch('/api/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        instruction: taskDescription,
                        browser: browser,
                        headless: mode === 'headless',
                        record: recording === 'on'
                    })
                });

                const response_json = await response.json();
                console.log('=== RAW Response ===', response_json);
                
                // Extract nested data
                const data = response_json.data || response_json;
                console.log('=== Extracted Data ===', data);
                console.log('Has code?', !!data.generated_code);
                console.log('Code length:', data.generated_code ? data.generated_code.length : 0);
                
                if (response_json.success && data) {
                    currentResult = data;
                    displayResults(data);
                    saveToHistory(data);
                } else {
                    alert('Test failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error running test: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        // Display results
        function displayResults(data) {
            console.log('=== Display Results Called ===');
            console.log('Data received:', JSON.stringify(data, null, 2));
            
            // Get values directly from response
            const total = parseInt(data.total_steps) || 0;
            const passed = parseInt(data.passed) || 0;
            const failed = parseInt(data.failed) || 0;
            const rate = parseFloat(data.success_rate) || 0;
            
            console.log('Parsed values:', { total, passed, failed, rate });

            // Update status summary with progress bar
            const hasFailed = failed > 0;
            const summary = document.getElementById('statusSummary');
            summary.className = 'status-summary' + (hasFailed ? ' failed' : '');
            document.getElementById('statusIcon').textContent = hasFailed ? '‚ùå' : '‚úÖ';
            document.getElementById('statusTitle').textContent = hasFailed ? 'Test Failed' : 'Test Passed';
            document.getElementById('statusSubtitle').innerHTML = `
                ${passed} of ${total} steps completed successfully (${rate.toFixed(1)}% success rate)
                <div class="progress-container">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar ${hasFailed ? 'failed-progress' : ''}" style="width: ${rate}%"></div>
                    </div>
                    <div class="progress-label">${passed} / ${total} Steps Completed</div>
                </div>
            `;

            // Update results grid with enhanced reporting metrics
            const executionTime = data.execution_time || 0;
            const browserUsed = data.browser || 'Unknown';
            
            document.getElementById('resultsGrid').innerHTML = `
                <div class="result-card">
                    <div class="result-label">Total Steps</div>
                    <div class="result-value">${total}</div>
                </div>
                <div class="result-card success">
                    <div class="result-label">Passed</div>
                    <div class="result-value">${passed}</div>
                </div>
                <div class="result-card error">
                    <div class="result-label">Failed</div>
                    <div class="result-value">${failed}</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Success Rate</div>
                    <div class="result-value">${rate.toFixed(0)}%</div>
                </div>
                <div class="result-card" style="background: rgba(139, 92, 246, 0.1); border-color: rgba(139, 92, 246, 0.3);">
                    <div class="result-label">‚è±Ô∏è Execution Time</div>
                    <div class="result-value">${executionTime}s</div>
                </div>
                <div class="result-card" style="background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
                    <div class="result-label">üåê Browser</div>
                    <div class="result-value" style="font-size: 0.95rem;">${browserUsed}</div>
                </div>
            `;

            // Update steps list
            let stepsHTML = '';
            if (data.actions) {
                data.actions.forEach((action, idx) => {
                    const stepNum = idx + 1;
                    const passedTest = data.passed_tests && data.passed_tests.find(t => t.step === stepNum);
                    const failedTest = data.failed_tests && data.failed_tests.find(t => t.step === stepNum);
                    const screenshot = (passedTest && passedTest.screenshot) || (failedTest && failedTest.screenshot);

                    const statusClass = passedTest ? 'passed' : (failedTest ? 'failed' : '');
                    const statusBadge = passedTest ? '<span class="step-badge passed">‚úì PASSED</span>' : 
                                       (failedTest ? '<span class="step-badge failed">‚úó FAILED</span>' : '');

                    stepsHTML += `
                        <div class="step-item ${statusClass}">
                            <div class="step-header">
                                <div class="step-title">Step ${stepNum}: ${action.type.toUpperCase()}</div>
                                ${statusBadge}
                            </div>
                            <div class="step-description">${action.description || ''}</div>
                            ${screenshot ? `
                                <div class="step-screenshot">
                                    <a href="/${screenshot}" target="_blank">
                                        üì∏ View Screenshot
                                    </a>
                                </div>
                            ` : ''}
                            ${failedTest && failedTest.error ? `
                                <div style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                                    <div style="color: #f87171; font-weight: 600; font-size: 0.9rem; margin-bottom: 4px;">Error Details:</div>
                                    <div style="color: #fca5a5; font-size: 0.85rem; font-family: 'Courier New', monospace;">${failedTest.error}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            document.getElementById('stepsList').innerHTML = stepsHTML;

            // Update code viewer
            console.log('Has generated_code?', !!data.generated_code);
            console.log('Code length:', data.generated_code ? data.generated_code.length : 0);
            
            if (data.generated_code) {
                const codeElement = document.getElementById('generatedCode');
                const codeSection = document.querySelector('.code-viewer');
                const codeContent = document.getElementById('codeContent');
                const codeIcon = document.getElementById('codeToggleIcon');
                
                console.log('Code elements found:', {
                    codeElement: !!codeElement,
                    codeSection: !!codeSection,
                    codeContent: !!codeContent,
                    codeIcon: !!codeIcon
                });
                
                if (codeElement && codeSection && codeContent && codeIcon) {
                    codeElement.textContent = data.generated_code;
                    codeSection.style.display = 'block';
                    codeContent.style.display = 'block';
                    codeContent.classList.add('open');
                    codeIcon.textContent = '‚ñº';
                    console.log('Code viewer updated and expanded!');
                } else {
                    console.error('Missing code viewer elements!');
                }
            } else {
                console.warn('No generated_code in response data');
            }

            // Show results
            document.getElementById('results').style.display = 'block';
        }

        // Toggle code viewer
        function toggleCode() {
            const content = document.getElementById('codeContent');
            const icon = document.getElementById('codeToggleIcon');
            const codeElement = document.getElementById('generatedCode');
            
            console.log('Toggle code clicked!');
            console.log('Content element:', content);
            console.log('Icon element:', icon);
            console.log('Code element:', codeElement);
            console.log('Code text length:', codeElement ? codeElement.textContent.length : 0);
            
            if (!content || !icon) {
                console.error('Missing elements!');
                return;
            }
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
                console.log('Code viewer closed');
            } else {
                content.classList.add('open');
                content.style.display = 'block';
                icon.textContent = '‚ñº';
                console.log('Code viewer opened');
            }
        }

        // Copy code
        function copyCode() {
            if (!currentResult || !currentResult.generated_code) {
                alert('No code to copy!');
                return;
            }

            navigator.clipboard.writeText(currentResult.generated_code).then(() => {
                const btn = event.target;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '‚úì Copied!';
                btn.style.background = 'rgba(34, 197, 94, 0.2)';
                btn.style.color = '#4ade80';
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        // Download report
        function downloadReport(format) {
            if (!currentResult) {
                alert('No test results to download!');
                return;
            }

            if (format === 'json') {
                const blob = new Blob([JSON.stringify(currentResult, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `test-report-${Date.now()}.json`;
                a.click();
            } else if (format === 'pdf') {
                fetch('/api/export/pdf', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentResult)
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `test-report-${Date.now()}.pdf`;
                    a.click();
                })
                .catch(error => alert('PDF export failed: ' + error));
            }
        }

        // New test
        function newTest() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('testForm').reset();
            currentResult = null;
        }

        // Clear form
        function clearForm() {
            document.getElementById('testForm').reset();
        }

        // Save to history
        function saveToHistory(data) {
            console.log('Saving to history:', data);
            const historyItem = {
                timestamp: new Date().toISOString(),
                url: data.url || 'N/A',
                passed: data.passed || 0,
                failed: data.failed || 0,
                rate: data.success_rate || 0,
                success: (data.failed || 0) === 0,
                ...data
            };
            console.log('History item:', historyItem);

            testHistory.unshift(historyItem);
            if (testHistory.length > 50) testHistory = testHistory.slice(0, 50);
            localStorage.setItem('testHistory', JSON.stringify(testHistory));
        }

        // Render history
        function renderHistory() {
            const list = document.getElementById('historyList');
            
            if (testHistory.length === 0) {
                list.innerHTML = '<p style="color: #64748b; text-align: center; padding: 40px;">No test history yet</p>';
                return;
            }

            list.innerHTML = testHistory.map(test => `
                <div class="history-item" onclick='loadHistoryTest(${JSON.stringify(test).replace(/'/g, "&apos;")})'>
                    <div class="history-time">${new Date(test.timestamp).toLocaleString()}</div>
                    <div class="history-url">${test.url}</div>
                    <div class="history-result">
                        ${test.passed || 0} passed, ${test.failed || 0} failed - ${(test.rate || 0).toFixed(1)}% success
                    </div>
                </div>
            `).join('');
        }

        // Load history test
        function loadHistoryTest(test) {
            console.log('Loading history test:', test);
            // Skip broken test entries
            if (!test.total_steps || test.total_steps === 0) {
                alert('This test result appears to be corrupted. Please run a new test.');
                return;
            }
            currentResult = test;
            displayResults(test);
        }

        // Clear history
        function clearHistory() {
            if (confirm('Are you sure you want to clear all test history? This action cannot be undone.')) {
                testHistory = [];
                localStorage.setItem('testHistory', JSON.stringify(testHistory));
                renderHistory();
                alert('Test history cleared successfully!');
            }
        }

        // Initialize
        renderHistory();
    </script>
</body>
</html>
